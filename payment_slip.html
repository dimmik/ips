<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Налог за уплату</title>
    <script src="qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .payment-slip {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 2px solid black;
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 400px;
        }
        
        .left-section {
            border-right: 2px solid black;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .right-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .field-label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #333;
        }
        
        .field-box {
            border: 1px solid black;
            padding: 8px;
            margin-bottom: 15px;
            min-height: 50px;
        }
        
        .field-box-large {
            border: 1px solid black;
            padding: 8px;
            margin-bottom: 15px;
            min-height: 90px;
        }
        
        .title {
            text-align: right;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .top-row {
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .code-box {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            min-width: 60px;
        }
        
        .currency-box {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            min-width: 60px;
        }
        
        .amount-box {
            border: 1px solid black;
            padding: 8px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
        }
        
        .account-box {
            border: 1px solid black;
            padding: 8px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        .reference-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .model-box {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            font-size: 16px;
            min-width: 60px;
        }
        
        .reference-box {
            border: 1px solid black;
            padding: 8px;
            font-size: 14px;
        }
        
        .qr-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: auto;
        }
        
        .qr-container {
            text-align: center;
        }
        
        .qr-label {
            font-size: 10px;
            margin-bottom: 5px;
        }
        
        .qr-placeholder {
            width: 150px;
            height: 150px;
            border: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .date-section {
            margin-top: 20px;
        }
        
        .date-label {
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .date-value {
            font-size: 16px;
        }
        
        .signature-section {
            margin-top: auto;
            padding-top: 40px;
        }
        
        .signature-label {
            font-size: 11px;
            border-top: 1px solid black;
            padding-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="payment-slip">
        <div class="left-section">
            <div>
                <div class="field-label">уплатилац</div>
                <div class="field-box" id="payer-details">
                    <!-- Payer details will be inserted here -->
                </div>
            </div>
            
            <div>
                <div class="field-label">сврха уплате</div>
                <div class="field-box" id="payment-purpose">
                    <!-- Payment purpose will be inserted here -->
                </div>
            </div>
            
            <div>
                <div class="field-label">прималац</div>
                <div class="field-box-large" id="recipient-details">
                    <!-- Recipient details will be inserted here -->
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature-label">печат и потпис уплатиоца</div>
                <div style="height: 60px;"></div>
                <div class="signature-label">место и датум пријема</div>
            </div>
        </div>
        
        <div class="right-section">
            <div class="title">НАЛОГ ЗА УПЛАТУ</div>
            
            <div class="top-row">
                <div>
                    <div class="field-label">шифра плаћања</div>
                    <div class="code-box" id="payment-code"></div>
                </div>
                <div>
                    <div class="field-label">валута</div>
                    <div class="currency-box">РСД</div>
                </div>
                <div>
                    <div class="field-label">износ</div>
                    <div class="amount-box" id="amount"></div>
                </div>
            </div>
            
            <div>
                <div class="field-label">рачун примаоца</div>
                <div class="account-box" id="recipient-account"></div>
            </div>
            
            <div class="reference-row">
                <div>
                    <div class="field-label">број модела</div>
                    <div class="model-box" id="model-number"></div>
                </div>
                <div>
                    <div class="field-label">позив на број (одобрење)</div>
                    <div class="reference-box" id="reference-number"></div>
                </div>
            </div>
            
            <div class="qr-section">
                <div>
                    <div class="date-section">
                        <div class="date-label">датум валуте</div>
                        <div class="date-value" id="currency-date"></div>
                    </div>
                </div>
                <div style="margin-left: auto;">
                    <div class="qr-container">
                        <div class="qr-label">NBS IPS QR</div>
                        <canvas class="qr-placeholder" id="qr-code-placeholder"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const qrString = params.get('qr');

            if (qrString) {
                const data = parseQRString(qrString);
                populatePaymentSlip(data, qrString);
            }
        });

        function parseQRString(str) {
            const parts = str.split('|');
            const data = {};
            parts.forEach(part => {
                const [key, ...valueParts] = part.split(':');
                const value = valueParts.join(':');
                switch(key) {
                    case 'K': data.k = value; break;
                    case 'V': data.v = value; break;
                    case 'C': data.c = value; break;
                    case 'R': data.r = value; break;
                    case 'N': data.n = value; break;
                    case 'I': data.i = value; break;
                    case 'SF': data.sf = value; break;
                    case 'S': data.s = value; break;
                    case 'PO': data.po = value; break; // Payer origin
                    case 'P': data.p = value; break; // Payer name
                }
            });
            return data;
        }

        function populatePaymentSlip(data, qrString) {
            document.getElementById('payer-details').innerText = data.p || '________________';
            
            document.getElementById('payment-purpose').innerText = data.s || '';
            document.getElementById('recipient-details').innerText = data.n || '';
            
            document.getElementById('payment-code').innerText = data.sf || '';
            
            if (data.i) {
                const amount = data.i.replace('RSD', '').replace(',', '.');
                document.getElementById('amount').innerText = parseFloat(amount).toFixed(2);
            }

            if (data.r) {
                const r = data.r;
                const formattedR = r.substring(0, 3) + '-' + r.substring(3, 16) + '-' + r.substring(16);
                document.getElementById('recipient-account').innerText = formattedR;
            }

            // Model and reference number are not standard in basic IPS QR. 
            // You might need a convention to pass them, e.g. in 'S' field.
            // For now, leaving them empty or with placeholders.
            document.getElementById('model-number').innerText = '97'; // Default or parse from somewhere
            document.getElementById('reference-number').innerText = data.po || '________________'; // Or parse from somewhere

            // Date
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('currency-date').innerText = `${day}.${month}.${year}`;

            // QR Code
            const qrPlaceholder = document.getElementById('qr-code-placeholder');
            const context = qrPlaceholder.getContext('2d');
            context.clearRect(0, 0, qrPlaceholder.width, qrPlaceholder.height);

            QRCode.toCanvas(qrPlaceholder, qrString, {
                width: 150,
                errorCorrectionLevel: 'H'
            }, function (error) {
                if (error) console.error(error);
            });
        }
    </script>
</body>
</html>
